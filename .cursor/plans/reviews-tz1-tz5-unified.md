# Объединённое ТЗ: Система отзывов (ТЗ 1–5)

Цель: отзывы как наглядная аналитика, мотивация писать отзывы, данные для AI-ранжирования, админка метрик.

**Порядок внедрения:** ТЗ-1 → ТЗ-2 → ТЗ-3 → ТЗ-4 → ТЗ-5.

---

## ТЗ-1 — База отзывов и метрик (предусловие)

Уже должно быть в проекте:

- **API:** POST `/reviews` (создание отзыва с метриками), GET `/reviews/listing/:id`, GET `/reviews/listing/:id/summary`, GET `/reviews/listing/:id/metrics`, GET `/reviews/user/:userId/summary`.
- **Форма отзыва:** ReviewWizard с звёздами, метриками (из пула), комментарием.
- **Хранение:** Review + ReviewMetric; агрегаты ListingMetricAgg; распределение по звёздам.

Фактические пути бэкенда (через API proxy на фронте):

- `GET /api/reviews/listing/:id` — список отзывов (query: `limit`, `skip`)
- `GET /api/reviews/listing/:id/summary` — `{ avg, count, distribution }`
- `GET /api/reviews/listing/:id/metrics` — `{ items: [{ metricKey, avgValue, count }] }`
- `GET /api/reviews/user/:userId/summary` — сводка по владельцу

---

## ТЗ-2 — Визуализация отзывов и аналитики

**Цель:** наглядный блок аналитики на странице объявления и в профиле владельца.

### 2.1 Блок «Отзывы» на странице объявления

- **Верхний агрегат:** ★ среднее, XX% положительных, «на основе N отзывов». Справа — кнопка «Оставить отзыв».
- **Гистограмма:** 5★ … 1★ с горизонтальными полосками и процентами.
- **Блок «Метрики жилья»:** карточка с 5–6 метриками (Чистота, Безопасность, Точность описания, Заселение, Цена/качество и т.д.) — строка вида «Чистота ███████████ 82%». Данные: `GET /reviews/listing/:id/metrics` (metrics_avg из агрегата).
- **Список отзывов:** карточка = звезда, дата, текст, мини-метрики (маленькие полоски), аватар автора. Пагинация: 10 отзывов, кнопка «Показать ещё».
- **Фильтры над списком:** все / только 5★ / только с текстом / последние (фильтрация на фронте).

**Текущее состояние:** В `ListingPageV2` уже есть агрегат, гистограмма, `ListingMetricsCard`, фильтры, список с `ReviewCard` и «Показать ещё». При необходимости — добить точное соответствие макету (подписи метрик, компактность гистограммы на мобильном).

### 2.2 Блок отзывов в профиле владельца

- Показывать **только когда другой пользователь смотрит профиль** (не в настройках своего профиля).
- **Верх профиля:** под именем — «★ 4.9  96%  N отзывов». Клик — переход к блоку отзывов (якорь на странице объявления или отдельная секция отзывов в профиле).
- **Метрики владельца:** блок «Как оценивают владельца» — коммуникация, скорость ответа, точность (если есть соответствующие метрики в агрегатах по объявлениям владельца).

**Текущее состояние:** В `app/user/[id]/page.tsx` рейтинг и N отзывов показываются только при `!isOwnProfile`. Блока «Метрики владельца» и списка отзывов в профиле может не быть — добавить при необходимости.

### 2.3 Карточка объявления в списке

- В списке объявлений показывать: **★ 4.8  92%** (без эмодзи, только иконка звезды).
- Данные: агрегаты из listing (rating, reviewPercent или расчёт из summary).

**Текущее состояние:** `ListingCardLight` принимает `rating` и `reviewPercent`, отображает их. Нужно проверить, что все места выдачи карточек (поиск, главная) передают эти поля из API и что бэкенд списка объявлений отдаёт рейтинг и % положительных.

### 2.4 Обновление после нового отзыва

- После POST отзыва: обновить агрегаты, карточку объявления и профиль владельца **без перезагрузки** (optimistic update или инвалидация запросов).

**Текущее состояние:** В `ReviewWizard` `onSubmitted` вызывается и инвалидируются `listing-reviews`, `listing-rating-summary`, `listing-metrics`. При необходимости добавить инвалидацию списка объявлений и профиля владельца.

### 2.5 Производительность и mobile

- Lazy load списка отзывов, skeleton loader, не грузить все отзывы сразу.
- Mobile: гистограмма компактная, метрики вертикальным списком, карточки отзывов с большими отступами, кнопка «Оставить отзыв» sticky.

### Acceptance (ТЗ-2)

1. На странице объявления есть блок аналитики (агрегат + гистограмма + метрики).
2. Видно распределение звёзд.
3. Видны метрики жилья.
4. Список отзывов пагинируется.
5. После отправки отзыва агрегаты обновляются.
6. В профиле владельца блок отображается только для чужих пользователей.
7. В карточке объявления в списке видно ★ 4.8  92%.

---

## ТЗ-3 — Геймификация и UX отзывов

**Цель:** мотивировать оставлять отзывы.

- Поп-ап через X ч после выезда: «Как прошло проживание?» — кнопки «Оставить отзыв» / «Позже».
- После отправки: маленький робот + текст «Спасибо! Отзыв помогает другим».
- Награда: «+5 к рейтингу пользователя» (только визуально).
- Мини-прогресс: «Вы помогли N людям выбрать жильё».
- Нет спама, можно отключить в настройках (или ссылкой в попапе).

**Статус:** Реализовано (см. `.cursor/plans/tz3-gamification-reviews.md`).

---

## ТЗ-4 — Подготовка отзывов под AI

**Цель:** данные для умного подбора.

- Структура: каждый отзыв хранит `metrics: { cleanliness, safety, communication, … }` (уже через ReviewMetric).
- **Endpoint:** GET `/analytics/listing/:id/reviews-summary` или использовать существующий GET `/reviews/listing/:id/summary` и при необходимости расширить ответ: средние метрики, тренд, последние 30 дней.
- В подборе пока только сохраняем; AI подключим позже.

**Задачи:** При необходимости добавить/расширить endpoint (например, под путём `GET /analytics/listing/:id/reviews-summary`) и возвращать `metrics_avg`, тренд, срез за 30 дней. Фронт может пока не менять — только контракт для будущего AI.

---

## ТЗ-5 — Админ-панель метрик отзывов

**Цель:** менять вопросы без кода.

- **Таблица метрик в админке:** список метрик (чистота, безопасность, точность и т.д.). Действия: включить/выключить, менять текст.
- **Ротация в форме отзыва:** в форме отзыва показывать 3 случайные метрики из включённого списка (сейчас используется пул из кода — перенести на админку или подгружать список с бэкенда).
- **Аналитика в админке:** таблица — топ объявлений по метрикам, худшие метрики.

**Задачи:** Модель/таблица метрик в БД (вкл/выкл, label), CRUD в админке, endpoint списка активных метрик для формы, форма отзыва берёт 3 из этого списка. Отдельный экран/табы аналитики: топ объявлений, худшие средние по метрикам.

---

## Чек-лист для агента

- [ ] **ТЗ-1:** Проверить наличие всех endpoint’ов и формы отзыва с метриками.
- [ ] **ТЗ-2:** Блок на объявлении (агрегат, гистограмма, метрики, список, фильтры, пагинация); профиль — только для чужих, при необходимости блок «Как оценивают владельца»; карточки в списке — ★ и %; обновление после отзыва; lazy + skeleton; mobile (sticky кнопка, компактная гистограмма).
- [ ] **ТЗ-3:** Готово.
- [ ] **ТЗ-4:** При необходимости расширить/добавить reviews-summary для AI (средние метрики, тренд, 30 дней).
- [ ] **ТЗ-5:** Админка: таблица метрик (вкл/выкл, текст), ротация 3 в форме, аналитика топ/худшие.

Файлы для правок (ориентир): `ListingPageV2.tsx`, `ReviewCard.tsx`, `ListingMetricsCard.tsx`, `ListingCardLight.tsx`, `app/user/[id]/page.tsx`, `ReviewWizard.tsx`, бэкенд: `reviews.controller.ts`, `reviews.service.ts`; админка и модель метрик — по текущей структуре проекта.
