# LOCUS — приведение в рабочее состояние перед пушем

**Цель:** полная стабилизация перед деплоем. UI синхронизирован с backend, роли/экономика/профиль/галерея работают.

---

## 1. ПРОБЛЕМА: ИЗМЕНЕНИЯ НЕ ОТОБРАЖАЮТСЯ НА САЙТЕ

**Проверить:**
- [ ] Ветка деплоя = main (Vercel → Settings → Git → Production branch)
- [ ] Vercel → Redeploy без кеша (Clear cache and redeploy)
- [ ] Supabase project подключен (env: NEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
- [ ] Таблицы созданы (profiles, etc.), миграции Supabase применены
- [ ] Миграции Neon/Prisma: `npx prisma migrate deploy` + `npx prisma generate`

**Done когда:** новые поля видны, роли работают, админ панель реагирует.

---

## 2. АДМИН ПАНЕЛЬ — РЕДИЗАЙН

**Дашборд — карточки (реальные данные из БД):**
- Пользователи, объявления, брони, доход, конверсия, LTV, ARPU, активные объявления, отмены, сообщения

**Юнит-экономика (таблица):**
| Метрика     | Формула              |
|-------------|----------------------|
| CAC         | расходы / клиенты    |
| LTV         | доход с клиента      |
| Конверсия   | брони / просмотры    |
| Доход       | оплаты               |
| GMV         | сумма бронирований   |

**Данные реальные из БД, не фейк.**

---

## 3. AI ПОМОЩНИК ДЛЯ АДМИНА

- Раздел `/admin/ai`
- Функции: анализ объявлений, подозрительные пользователи, рекомендации цены, аналитика спроса
- Кнопка: «Проанализировать платформу»

---

## 4. ПРОФИЛЬ ВЛАДЕЛЬЦА

**Карточка владельца на странице объявления:**
- Аватар, имя, рейтинг, кол-во объявлений, «отвечает быстро», кнопка «Профиль»

**Страница профиля:** `/user/[id]`
- Все объявления пользователя (активные), рейтинг, отзывы

**Логика:** telegram / sms / email → один аккаунт (связка по user_id).

---

## 5. ГАЛЕРЕЯ ФОТО

**Мобильный:** свайп, индикатор, zoom  
**ПК:** стрелки, клавиатура (←/→), миниатюры

---

## 6. ЧАТ 1-1

- Страница `/messages`: список диалогов, уведомления, онлайн, отправка фото
- Админ видит все чаты (уже есть вкладка Чаты)

---

## 7. УВЕДОМЛЕНИЯ

- Web Push (браузер), колокольчик в шапке
- Админ: отправить всем / пользователю (уже есть Push вкладка)

---

## 8. РОЛИ

- user, manager, admin (уже: USER, MODERATOR, MANAGER, ADMIN, ROOT)
- Админ назначает менеджера, доступ к чатам, модерация, аналитика

---

## 9. ЭКОНОМИКА

- Таблица payments: user_id, amount, status, type, created_at (тест-режим)

---

## 10. СВЯЗКА АККАУНТОВ

- user_id, phone, email, telegram_id — один аккаунт при входе через telegram/sms/email

---

## ЧТО СДЕЛАТЬ ПРЯМО СЕЙЧАС

| # | Задача                          | Статус   |
|---|----------------------------------|----------|
| 1 | Проверить деплой (ветка, redeploy, env) | Готово (чек-лист в DEPLOY_CHECKLIST) |
| 2 | Проверить Supabase (таблицы, миграции)  | В чек-листе |
| 3 | Синхронизировать роли                   | Готово   |
| 4 | Исправить профиль владельца + /user/[id] | Готово (API + страница /user/[id], ссылка «Профиль») |
| 5 | Исправить галерею (свайп, стрелки, миниатюры) | Готово (стрелки, клавиатура, свайп, миниатюры на ПК) |
| 6 | Добавить экономику (payments, метрики в админке) | Готово (модель Payment, миграция 15, дашборд: GMV, доход, конверсия, таблица юнит-экономики) |
| 7 | Добавить AI блок /admin/ai              | Готово (страница /admin/ai, кнопка «Проанализировать платформу», ссылка из админки) |

---

## Файлы

- Деплой: `docs/DEPLOY_CHECKLIST.md`
- Админ: `frontend/app/admin/AdminDashboardV2.tsx`, `backend/src/modules/admin/`
- Галерея: `frontend/components/listing/ListingGallery.tsx`
- Профиль владельца: `frontend/components/listing/ListingOwner.tsx`, `frontend/app/user/[id]/page.tsx` (новый)
- Payments: миграция Prisma + AdminService (GMV из Booking, таблица Payment)
