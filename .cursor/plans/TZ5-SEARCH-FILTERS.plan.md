# ТЗ-5: Блок поиска, фильтров и логика подбора

**Цель:** поиск без зависаний и разрывов; единый поток за 5–7 действий; фильтры скроллятся; переход к результатам без лишних страниц.

## Статус: ✅ Выполнено

## Что сделано

### 1. Единый источник состояния
- Используется существующий `useFilterStore` (Zustand) — один store для города, бюджета, типа, срока, aiMode.

### 2. Переход к результатам без новой страницы
- На главной кнопка «Показать варианты» больше не ведёт на `/listings`.
- Выполняется: проверка города → `setSearchApplied(true)` → плавный скролл к `#listings`.
- Секция «Актуальные предложения» имеет `id="listings"` и `scroll-mt-4`.
- При `searchApplied` и выбранном городе запрос списка идёт с параметрами: `city`, `priceMin`, `priceMax`, при необходимости `ai=true`. Ключ и URL `useFetch` зависят от этих параметров.

### 3. Sticky-поиск (72px)
- При скролле вниз (когда блок `#search` уходит вверх) показывается фиксированная панель под шапкой (`top: var(--header-height, 64px)`).
- Высота панели 72px, содержимое: город | бюджет | кнопка «Фильтры» | «Показать».
- Классы: `home-search-sticky-tz5`, стили в `home-tz18.css`.

### 4. Табы «Умный подбор» / «Ручной поиск»
- Над формой поиска добавлен переключатель (два таба).
- Состояние берётся из `aiMode` в store, переключение через `setAiMode(true/false)`.
- При «Умный подбор» в запрос списка при необходимости добавляется `ai=true`.

### 5. Фильтры: скролл и фикс. шапка/подвал
- **Body:** при открытых фильтрах (desktop и mobile) выставляется `document.body.style.overflow = 'hidden'` (в `HomePageV6` и в `BottomSheet`).
- **Mobile (BottomSheet):**
  - Панель с `height: 90vh` при открытии (через `height: open ? maxHeight : undefined` в BottomSheet).
  - Внутри: шапка (Фильтры, Сбросить, Закрыть) → прокручиваемая область с `FilterPanel` (`flex-1 min-h-0 overflow-y-auto`) → фиксированный подвал с кнопками «Сбросить» и «Применить».
  - В модалке у `FilterPanel` отключены кнопки поиска (`showSearchButtons={false}`), действие только с подвала.
- **Desktop (dropdown):**
  - Модалка задана как flex-колонка с фиксированной высотой `80vh`.
  - Шапка (Фильтры, Сбросить, Закрыть) → прокручиваемая область с `FilterPanel` → фиксированный подвал «Сбросить» и «Применить».
  - Контент скроллится внутри, body не скроллится.

### 6. Отступы
- Блок поиска уже входит в секции с `home-tz3-block` (32–40px). Дополнительно убран лишний margin у обёртки поиска в контексте ТЗ-3.

### 7. Кнопка «Подобрать жильё» (Hero)
- По ТЗ-3: скролл к `#search` на той же странице (при отсутствии города); при выбранном городе — переход к результатам (скролл к `#listings` через `handleHeroCta` / общую логику).

## Файлы

- `frontend/app/HomePageV6.tsx` — состояние `searchApplied`, `stickySearchVisible`, эффект блокировки скролла body при открытых фильтрах, ключ/URL для `useFetch` с параметрами поиска, табы Умный/Ручной, sticky-панель, секция `#listings`, десктопная и мобильная модалки фильтров с фикс. подвалом и скроллом внутри.
- `frontend/components/ui/BottomSheet.tsx` — при открытии панели задаётся `height: maxHeight`, чтобы внутренний flex и `overflow-y-auto` работали.
- `frontend/styles/home-tz18.css` — стили для `.home-search-sticky-tz5` (top под шапкой, высота 72px).

## Критерии готовности (ТЗ)

- [x] Поиск не зависает (body lock, скролл только внутри модалки).
- [x] Фильтры скроллятся (desktop и mobile).
- [x] Кнопки логичны (Применить/Сбросить внизу модалки; «Показать варианты» → scroll к результатам).
- [x] Нет пустых зон (отступы через home-tz3-block).
- [x] UX цельный (одна страница, scroll к результатам, один store).
- [x] 5–7 действий до результата (город → бюджет → Показать → scroll к карточкам).

## Что не делали

- Отдельная страница результатов с sticky-фильтром (ТЗ описывает её; текущая реализация — результаты на главной и scroll к ним).
- Расширение набора полей в фильтрах (район, метро, этаж, мебель, животные) — оставлено на будущее; состав фильтров в `FilterPanel` не менялся.
