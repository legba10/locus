import { Injectable } from "@nestjs/common";
import { AiAssistantRequestDto } from "../dto/ai-assistant.dto";

@Injectable()
export class AiAssistantService {
  async reply(dto: AiAssistantRequestDto) {
    const msg = dto.message.trim().toLowerCase();

    if (dto.role === "guest") {
      if (msg.includes("почему") || msg.includes("подходит")) {
        return {
          reply:
            "Я могу объяснить подбор: учитываю бюджет, город и приоритеты (тишина/метро). Если скажете район и важные удобства — уточню и пересчитаю результаты.",
          suggestions: [
            "Уточнить район/станцию метро",
            "Сказать, важна ли тишина ночью или днём",
            "Нужны ли парковка/интернет/рабочее место",
          ],
          actions: [{ type: "ask_clarifying_questions", payload: { fields: ["district", "metro", "amenities"] } }],
        };
      }
      if (msg.includes("риск") || msg.includes("безопас")) {
        return {
          reply:
            "Проверяю риски по сигналам объявления и профиля хоста (полнота данных, локация, история, аномалии). В MVP это базовые эвристики; позже подключим антифрод и поведенческую аналитику.",
          suggestions: [
            "Смотрите на полноту описания и правила",
            "Уточняйте условия заселения/депозит в чате",
            "Выбирайте варианты с прозрачной политикой отмены",
          ],
        };
      }
      return {
        reply:
          "Опишите, что вам важно (бюджет, район/метро, тишина, срок) — и я подберу варианты с объяснением и альтернативами.",
      };
    }

    if (dto.role === "host") {
      if (msg.includes("цена") || msg.includes("прайс") || msg.includes("дорого") || msg.includes("дёшево")) {
        return {
          reply:
            "Я могу рекомендовать цену, опираясь на спрос (сигналы метро/тишина) и качество объявления. В MVP это эвристики, дальше добавим прогноз загрузки и сравнение по рынку.",
          suggestions: [
            "Улучшить качество объявления (описание/координаты/сигналы)",
            "Включить instant booking (если поддержим)",
            "Тестировать цену A/B по неделям",
          ],
        };
      }
      return {
        reply:
          "Я помогу повысить загрузку: покажу Quality Score, предложу оптимизацию цены и укажу риски/узкие места в объявлении.",
      };
    }

    // admin
    return {
      reply:
        "Я могу подсвечивать кластеры риска, аномалии и очереди модерации. В MVP верну explainable сигналы; дальше подключим граф и поведенческие модели.",
      suggestions: ["Открыть risk map", "Посмотреть fraud clusters", "Проверить quality heatmap"],
    };
  }
}

